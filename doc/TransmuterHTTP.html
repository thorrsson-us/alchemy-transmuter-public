<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: TransmuterHTTP
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!TransmuterHTTP.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (T)</a> &raquo;
    
    
    <span class="title">TransmuterHTTP</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: TransmuterHTTP
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Sinatra::Base</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Sinatra::Base</li>
          
            <li class="next">TransmuterHTTP</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/http.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>HTTP interface / routes - main sinatra class.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#AGET__-instance_method" title="#AGET / (instance method)">- (Object) <strong>AGET /</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Requested by iPXE on boot, chains into /boot.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#AGET__boot-instance_method" title="#AGET /boot (instance method)">- (Object) <strong>AGET /boot</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Requested by iPXE, renders an boot menu.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#AGET__r__spell_render____spell__w______render__w___-instance_method" title="#AGET %r{/spell/render/(?&lt;spell&gt;\\w*)/(?&lt;render&gt;\\w*)} (instance method)">- (Object) <strong>AGET %r{/spell/render/(?&lt;spell&gt;\w*)/(?&lt;render&gt;\w*)}</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Dynamically map render requests to spells.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#AGET__spell_cast-instance_method" title="#AGET /spell/cast (instance method)">- (Object) <strong>AGET /spell/cast</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Cast new spell on an asset.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#AGET__spell_notify-instance_method" title="#AGET /spell/notify (instance method)">- (Object) <strong>AGET /spell/notify</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Map notifications to spell jobs, and get appropriate response.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (TransmuterHTTP) <strong>initialize</strong> </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>We hardcode showing exceptions to off This is because we define our own
exception handler below see ( #handle_exception! ).</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="TransmuterHTTP (class)">TransmuterHTTP</a></span></tt>) <strong>initialize</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>We hardcode showing exceptions to off This is because we define our own
exception handler below see ( #handle_exception! )</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


70
71
72
73</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/http.rb', line 70</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_show_exceptions'>show_exceptions</span> <span class='op'>=</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="AGET__-instance_method">
  
    - (<tt>Object</tt>) <strong>AGET /</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Requested by iPXE on boot, chains into /boot. This enables us to customize
what details we want iPXE to send us The iPXE undionly.kpxe should contain
an embedded script to call this URL</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


85
86
87</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/http.rb', line 85</span>

<span class='id identifier rubyid_aget'>aget</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_body'>body</span> <span class='lbrace'>{</span><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:boot</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="AGET__boot-instance_method">
  
    - (<tt>Object</tt>) <strong>AGET /boot</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 400: missing required parameter</p>
</div>
  </div>


<p>Requested by iPXE, renders an boot menu. Using the parameters, a sku is
computed and looked up in Collins to decide what to do. The default boot
option can be overriden programattically here, otherwise fall back to bios
boot.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>mac</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SMBios attribute for current mac address</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>serial</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SMBios attribute for chassis serial</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>product</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SMBios attribute for chassis product</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>manufacturer</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SMBios attribute for manufacturer</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>board-serial</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SMBios attribute for motherboard serial</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>board-product</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SMBios attribute for motherboard product</p>
</li></ul>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/http.rb', line 99</span>

<span class='id identifier rubyid_aget'>aget</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/boot</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Boot: Got these params: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing mac</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mac</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing serial</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>serial</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing product</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>product</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing manufacturer</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>manufacturer</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing board-serial</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>board-serial</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing board-product</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>board-product</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='id identifier rubyid_config_hash'>config_hash</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span>
  <span class='id identifier rubyid_sku'>sku</span> <span class='op'>=</span> <span class='id identifier rubyid_compute_sku'>compute_sku</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>manufacturer</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>serial</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>board-serial</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sku'>sku</span>

 <span class='comment'># begin 
</span> <span class='comment'>#   puts &quot;Asking collins&quot;
</span> <span class='comment'>#   asset = @collins.getAsset(sku)
</span> <span class='comment'>#   puts &quot;back from collins&quot;
</span> <span class='comment'># rescue
</span> <span class='comment'>#   puts &quot;Couldn&#39;t connect to collins :(&quot;
</span> <span class='comment'>#   halt(500,&quot;Can&#39;t connect to collins&quot;) 
</span> <span class='comment'># end
</span>
 <span class='comment'># if asset.nil?
</span>
 <span class='comment'>#     puts &quot;Asset #{sku} is unknown, we&#39;ll make it&quot;
</span> <span class='comment'>#     intake = IntakeSpell.new(
</span> <span class='comment'>#         :sku =&gt; sku
</span> <span class='comment'>#     )
</span> <span class='comment'>#     intake.save
</span>
 <span class='comment'>#     # Modify the options hash to set the default options in the menu
</span> <span class='comment'>#     opts[&#39;menu_default&#39;] = &quot;alchemy&quot;
</span> <span class='comment'>#     opts[&#39;callback&#39;] = &quot;/spell/notify?sku=#{sku}&amp;message=booted&quot;
</span>
 <span class='comment'># else
</span> <span class='comment'>#     puts &quot;Asset #{sku} is known&quot;
</span> <span class='comment'>#     puts asset
</span>
 <span class='comment'>#     # Check if there is a spell taking care of this
</span> <span class='comment'>#     running = Asset.first(:sku =&gt; sku) 
</span>
 <span class='comment'>#     if not running.nil?
</span> <span class='comment'>#       # If so, let it decide what it should do and potentially override boot options
</span> <span class='comment'>#       options = running.respond(opts)
</span> <span class='comment'>#     end
</span> <span class='comment'># end
</span>
  <span class='comment'># Render the iPXE boot menu
</span>  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>coreos</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>builds</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_body'>body</span> <span class='lbrace'>{</span><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:menu</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:opts</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_opts'>opts</span><span class='comma'>,</span> <span class='symbol'>:spells</span> <span class='op'>=&gt;</span> <span class='gvar'>$menu_spells</span> <span class='rbrace'>}</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="AGET__r__spell_render____spell__w______render__w___-instance_method">
  
    - (<tt>Object</tt>) <strong>AGET %r{/spell/render/(?&lt;spell&gt;\w*)/(?&lt;render&gt;\w*)}</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note todo">
    <strong>TODO:</strong>
    <div class='inline'>
<p>also allow this to route to instance methods, not just class methods.</p>
</div>
  </div>


  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 400: missing required parameter</p>
</div>
  </div>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 409: request is invalid - invalid spell or invalid render method.</p>
</div>
  </div>


<p>Dynamically map render requests to spells. All extra paramaters are sent to
the spell, so additional params may be required as enforced by spell render
method.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>spell</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>URI param (see above regex), spell to notify</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>render</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>URI param (see above regex), render method to call</p>
</li></ul>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


235
236
237
238
239
240
241
242
243
244
245
246
247
248</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/http.rb', line 235</span>

<span class='id identifier rubyid_aget'>aget</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>/spell/render/(?&lt;spell&gt;\w*)/(?&lt;render&gt;\w*)</span><span class='regexp_end'>}</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing spell name</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spell</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing render method</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>render</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Very important to sanity check the params here/ because we are going to &#39;eval&#39;.
</span>  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>409</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid spell</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='gvar'>$spells</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spell</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_spellname'>spellname</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spell</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_capitalize'>capitalize</span><span class='embexpr_end'>}</span><span class='tstring_content'>Spell</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># We make sure that the spell specified has a renderer
</span>  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>409</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>spell </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_spellname'>spellname</span><span class='embexpr_end'>}</span><span class='tstring_content'> doesn&#39;t implement render_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>render</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_eval'>eval</span><span class='lparen'>(</span><span class='id identifier rubyid_spellname'>spellname</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>render_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>render</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

    <span class='comment'># Pass it off to the spell to render
</span>  <span class='id identifier rubyid_body'>body</span> <span class='lbrace'>{</span><span class='id identifier rubyid_eval'>eval</span><span class='lparen'>(</span><span class='id identifier rubyid_spellname'>spellname</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_method'>method</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>render_</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>render</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span><span class='ivar'>@env</span><span class='comma'>,</span><span class='id identifier rubyid_config_hash'>config_hash</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span><span class='comma'>,</span><span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="AGET__spell_cast-instance_method">
  
    - (<tt>Object</tt>) <strong>AGET /spell/cast</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 400: missing required parameter</p>
</div>
  </div>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 409: specified spell does not exist / is not loaded.</p>
</div>
  </div>


<p>Cast new spell on an asset. All extra params will also be passed to the
spell for it to handle if it chooses.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>sku</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SKU for the asset to cast the spell on</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>spell</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>Spell to cast on the asset</p>
</li></ul>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/http.rb', line 158</span>

<span class='id identifier rubyid_aget'>aget</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/spell/cast</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>

  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>got params </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing sku</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing spell</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spell</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>409</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid spell</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='gvar'>$spells</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spell</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>


  <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_menu'>menu</span>
  <span class='id identifier rubyid_spellname'>spellname</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>spell</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_capitalize'>capitalize</span><span class='embexpr_end'>}</span><span class='tstring_content'>Spell</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_sku'>sku</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sku'>sku</span>

  <span class='id identifier rubyid_asset'>asset</span> <span class='op'>=</span> <span class='const'>Asset</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span><span class='symbol'>:sku</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_sku'>sku</span> <span class='rparen'>)</span> 

  <span class='kw'>if</span> <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_asset'>asset</span> <span class='op'>=</span> <span class='const'>Asset</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span>
        <span class='symbol'>:sku</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_sku'>sku</span>
    <span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Saved</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> 
        <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span>
      <span class='kw'>end</span> 
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_spell'>spell</span> <span class='op'>=</span> <span class='id identifier rubyid_eval'>eval</span><span class='lparen'>(</span><span class='id identifier rubyid_spellname'>spellname</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='symbol'>:sku</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_sku'>sku</span><span class='comma'>,</span> <span class='symbol'>:asset</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_spell'>spell</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Saved</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_spell'>spell</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span> 
      <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span> 
  <span class='kw'>end</span>

  <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_pushSpell'>pushSpell</span><span class='lparen'>(</span><span class='id identifier rubyid_spell'>spell</span><span class='rparen'>)</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="AGET__spell_notify-instance_method">
  
    - (<tt>Object</tt>) <strong>AGET /spell/notify</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 400: missing required parameter</p>
</div>
  </div>

  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'>
<p>HTTP 409: there is no spell for specified asset, or there is no asset -
nothing to notify.</p>
</div>
  </div>


<p>Map notifications to spell jobs, and get appropriate response</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>sku</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>SKU for the asset to cast the spell on</p>
</li></ul>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>message</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><ul><li>
<p>Message to send to the spell</p>
</li></ul>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/http.rb', line 205</span>

<span class='id identifier rubyid_aget'>aget</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/spell/notify</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>do</span>

  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing sku</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>400</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>missing message</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>message</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>got params </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_sku'>sku</span>      <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_message'>message</span>  <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>message</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_asset'>asset</span> <span class='op'>=</span> <span class='const'>Asset</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span><span class='symbol'>:sku</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_sku'>sku</span><span class='rparen'>)</span> 
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>409</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No knowledge of asset </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_sku'>sku</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='kw'>not</span> <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_spell'>spell</span> <span class='op'>=</span> <span class='id identifier rubyid_asset'>asset</span><span class='period'>.</span><span class='id identifier rubyid_getSpell'>getSpell</span>
  <span class='id identifier rubyid_halt'>halt</span><span class='lparen'>(</span><span class='int'>409</span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No spells for asset </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_sku'>sku</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='kw'>not</span> <span class='id identifier rubyid_spell'>spell</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_menu'>menu</span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sku</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sku'>sku</span>

  <span class='id identifier rubyid_spell'>spell</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_body'>body</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_spell'>spell</span><span class='period'>.</span><span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span> <span class='id identifier rubyid_options'>options</span> <span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Jun 20 09:53:40 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.0).
</div>

  </body>
</html>